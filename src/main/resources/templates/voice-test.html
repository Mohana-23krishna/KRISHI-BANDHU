<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Bandhu - AI Voice Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 500;
        }
        
        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-small:active {
            transform: translateY(0);
        }
        
        select.btn-small {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }
        
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .recording-indicator.active {
            display: flex;
        }
        
        .recording-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-red 1.5s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            scroll-behavior: smooth;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .message-group {
            display: flex;
            gap: 16px;
            padding: 20px 16px;
            max-width: 768px;
            margin: 0 auto;
        }
        
        .message-group.user {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            margin: 8px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .message-group.assistant {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            margin: 8px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .avatar.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .avatar.assistant {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .message-content {
            flex: 1;
            line-height: 1.75;
            font-size: 0.95rem;
            color: #333;
        }
        
        .message-content p {
            margin-bottom: 12px;
            color: #333;
        }
        
        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        .crop-details-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .crop-details-card h4 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-size: 0.85rem;
        }
        
        .detail-value {
            color: #333;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .input-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(102, 126, 234, 0.2);
            padding: 12px 16px;
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .mic-button-inline {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            color: white;
            font-size: 1.5rem;
        }
        
        .mic-button-inline:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .mic-button-inline.recording {
            background: #ef4444;
            animation: pulse-mic 1.5s infinite;
        }
        
        @keyframes pulse-mic {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .input-box {
            flex: 1;
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 12px 16px;
            color: #333;
            font-size: 0.95rem;
            resize: none;
            min-height: 52px;
            max-height: 200px;
            font-family: inherit;
            line-height: 1.5;
            transition: border-color 0.2s;
        }
        
        .input-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-box::placeholder {
            color: #999;
        }
        
        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            color: white;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .send-button:disabled {
            background: #565869;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: none;
            padding: 20px 16px;
            max-width: 768px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            margin-top: 8px;
        }
        
        .typing-indicator.active {
            display: flex;
            gap: 16px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
            margin-left: 48px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-screen.hidden {
            display: none;
        }
        
        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .welcome-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 32px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .start-button {
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        /* Responsive */
        @media screen and (max-width: 768px) {
            .message-group {
                padding: 16px 12px;
            }
            
            .input-wrapper {
                padding: 0 12px;
            }
            
            .header h1 {
                font-size: 1rem;
            }
            
            .btn-small {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
        }
        
        @media screen and (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
            
            .header-controls {
                gap: 6px;
            }
            
            .message-group {
                gap: 12px;
                padding: 12px;
            }
            
            .avatar {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
            
            .message-content {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåæ Krishi Bandhu</h1>
        <div class="header-controls">
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span>Listening...</span>
            </div>
            <button class="btn-small mic-button" id="startRecordBtn" onclick="startConversation()" title="Click to start recording">
                <span style="font-size: 1.2rem;">üé§</span> Start Recording
            </button>
            <button class="btn-small" id="stopRecordBtn" onclick="stopConversation()" style="display: none;">‚èπÔ∏è Stop Recording</button>
            <select id="languageSelect" class="btn-small" style="padding: 6px 8px;">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="te">Telugu</option>
                <option value="ta">Tamil</option>
            </select>
        </div>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-icon">üåæ</div>
            <div class="welcome-title">Welcome to Krishi Bandhu</div>
            <div class="welcome-subtitle">Your AI farming assistant. Speak naturally and get help with selling crops, farming advice, and more.</div>
            <button class="start-button" onclick="startConversation()">Start Conversation</button>
        </div>
        <div id="conversationHistory"></div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="avatar assistant">ü§ñ</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>
    
        <div class="input-area">
        <div class="input-wrapper">
            <button 
                class="mic-button-inline" 
                id="micButton" 
                onclick="toggleMicRecording()" 
                title="Click to start/stop voice recording"
            >
                üé§
            </button>
            <textarea 
                id="textInput" 
                class="input-box" 
                placeholder="Type your message or click microphone to use voice..."
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>‚û§</button>
        </div>
    </div>
    
    <script>
        let recognition = null;
        let isRecording = false;
        let isProcessing = false;
        let isSpeaking = false;
        let conversationHistory = [];
        let currentSentence = '';
        let silenceTimer = null;
        let collectedData = {
            farmerName: null,
            location: null,
            cropName: null,
            quantity: null,
            price: null
        };
        let conversationState = 'greeting'; // greeting, asking_name, asking_location, asking_crop, asking_quantity, asking_price, confirming
        const synth = window.speechSynthesis;
        
        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    }
                }
                
                if (finalTranscript) {
                    currentSentence += finalTranscript;
                    updateTextInput(currentSentence);
                    
                    clearTimeout(silenceTimer);
                    silenceTimer = setTimeout(() => {
                        if (currentSentence.trim() && !isProcessing && !isSpeaking) {
                            processMessage(currentSentence.trim());
                            currentSentence = '';
                        }
                    }, 1500);
                }
            };
            
            recognition.onerror = function(event) {
                if (event.error === 'no-speech') return;
                if (event.error === 'aborted' || event.error === 'network') {
                    stopConversation();
                }
            };
            
            recognition.onend = function() {
                if (isRecording && !isSpeaking) {
                    try {
                        recognition.start();
                    } catch (e) {
                        setTimeout(() => {
                            if (isRecording && !isSpeaking) {
                                try {
                                    recognition.start();
                                } catch (e2) {
                                    stopConversation();
                                }
                            }
                        }, 100);
                    }
                }
            };
        }
        
        function startConversation() {
            if (!recognition) {
                alert('Speech recognition not supported. Please use text input.');
                return;
            }
            
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('startRecordBtn').style.display = 'none';
            document.getElementById('stopRecordBtn').style.display = 'inline-block';
            document.getElementById('recordingIndicator').classList.add('active');
            
            const language = document.getElementById('languageSelect').value;
            recognition.lang = getLanguageCode(language);
            
            try {
                recognition.start();
                isRecording = true;
                document.getElementById('micButton').classList.add('recording');
                
                // Add welcome message and start collecting information
                if (conversationHistory.length === 0) {
                    const welcomeMsg = "Hello! I'm Krishi Bandhu, your farming assistant. I'll help you sell your crops. Let me start by collecting some information. First, what's your name?";
                    addAIMessage(welcomeMsg);
                    speakText(welcomeMsg, false);
                    conversationState = 'asking_name';
                }
            } catch (e) {
                alert('Could not start recording. Please check microphone permissions.');
            }
        }
        
        function stopConversation() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            synth.cancel();
            isSpeaking = false;
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            document.getElementById('startRecordBtn').style.display = 'inline-block';
            document.getElementById('stopRecordBtn').style.display = 'none';
            document.getElementById('recordingIndicator').classList.remove('active');
            document.getElementById('micButton').classList.remove('recording');
            currentSentence = '';
        }
        
        function toggleMicRecording() {
            if (!isRecording) {
                startConversation();
            } else {
                stopConversation();
            }
        }
        
        function getLanguageCode(lang) {
            const codes = {
                'hi': 'hi-IN',
                'te': 'te-IN',
                'ta': 'ta-IN',
                'kn': 'kn-IN',
                'ml': 'ml-IN',
                'mr': 'mr-IN',
                'gu': 'gu-IN',
                'bn': 'bn-IN',
                'pa': 'pa-IN'
            };
            return codes[lang] || 'en-US';
        }
        
        async function processMessage(message) {
            if (!message.trim() || isProcessing || isSpeaking) return;
            
            isProcessing = true;
            addUserMessage(message);
            showTyping(true);
            
            if (recognition && isRecording) {
                recognition.stop();
            }
            
            try {
                const language = document.getElementById('languageSelect').value;
                const phone = '+919876543210';
                
                const response = await fetch('/api/voice/conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        speechText: message,
                        phone: phone,
                        language: language,
                        conversationHistory: conversationHistory
                    })
                });
                
                const data = await response.json();
                showTyping(false);
                
                let aiResponse = data.response || "I understand. Let me help you with that.";
                const responseData = data.data || {};
                
                // Process collected data based on conversation state
                let nextQuestion = processCollectedData(message, data, responseData);
                
                // Force the next question based on conversation state
                if (nextQuestion) {
                    // Override AI response if we need to ask a specific question
                    aiResponse = nextQuestion;
                }
                
                // Display farmer and crop details if available
                addAIMessage(aiResponse, responseData);
                
                speakText(aiResponse, true);
                
                // Update conversation history
                conversationHistory.push({ role: 'user', content: message });
                conversationHistory.push({ role: 'assistant', content: aiResponse });
                
                // Keep only last 10 messages for context
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
                // Summary is shown automatically in processCollectedData when all data is collected
                
            } catch (error) {
                showTyping(false);
                const errorMsg = "Sorry, I encountered an error. Please try again.";
                addAIMessage(errorMsg);
                speakText(errorMsg, true);
            } finally {
                isProcessing = false;
                
                setTimeout(() => {
                    if (isRecording && !isSpeaking) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Resuming recognition');
                        }
                    }
                }, 500);
            }
        }
        
        function addUserMessage(text) {
            const container = document.getElementById('conversationHistory');
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group user';
            messageGroup.innerHTML = `
                <div class="avatar user">üë§</div>
                <div class="message-content">${escapeHtml(text)}</div>
            `;
            container.appendChild(messageGroup);
            scrollToBottom();
        }
        
        function addAIMessage(text, data = null) {
            const container = document.getElementById('conversationHistory');
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group assistant';
            
            let content = `<div class="message-content">${formatMessage(text)}</div>`;
            
            // Display details if farmer provided information
            if (data && (data.cropName || data.farmerName || data.location)) {
                content += `
                    <div class="crop-details-card">
                        <h4>üìã ${data.cropName ? 'Crop Listing Created' : 'Farmer Information'}</h4>
                        ${data.farmerName ? `
                        <div class="detail-row">
                            <span class="detail-label">üë§ Farmer Name:</span>
                            <span class="detail-value">${escapeHtml(data.farmerName)}</span>
                        </div>` : ''}
                        ${data.location ? `
                        <div class="detail-row">
                            <span class="detail-label">üìç Location/Region:</span>
                            <span class="detail-value">${escapeHtml(data.location)}</span>
                        </div>` : ''}
                        ${data.cropName ? `
                        <div class="detail-row">
                            <span class="detail-label">üåæ Crop Name:</span>
                            <span class="detail-value">${escapeHtml(data.cropName)}</span>
                        </div>` : ''}
                        ${data.quantity ? `
                        <div class="detail-row">
                            <span class="detail-label">üì¶ Quantity:</span>
                            <span class="detail-value">${data.quantity} kg</span>
                        </div>` : ''}
                        ${data.price ? `
                        <div class="detail-row">
                            <span class="detail-label">üí∞ Price:</span>
                            <span class="detail-value">‚Çπ${data.price} per kg</span>
                        </div>` : ''}
                    </div>
                `;
            }
            
            messageGroup.innerHTML = `
                <div class="avatar assistant">ü§ñ</div>
                ${content}
            `;
            container.appendChild(messageGroup);
            scrollToBottom();
        }
        
        function formatMessage(text) {
            // Convert line breaks to paragraphs
            return text.split('\n').filter(line => line.trim()).map(line => 
                `<p>${escapeHtml(line.trim())}</p>`
            ).join('');
        }
        
        function speakText(text, isAI) {
            if (!text || !synth) return;
            
            synth.cancel();
            isSpeaking = true;
            
            const utterance = new SpeechSynthesisUtterance(text);
            const language = document.getElementById('languageSelect').value;
            utterance.lang = getLanguageCode(language);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onend = function() {
                isSpeaking = false;
                if (isRecording && !isProcessing) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Resuming recognition');
                        }
                    }, 300);
                }
            };
            
            utterance.onerror = function() {
                isSpeaking = false;
                if (isRecording && !isProcessing) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Resuming recognition after error');
                        }
                    }, 300);
                }
            };
            
            synth.speak(utterance);
        }
        
        function showTyping(show) {
            document.getElementById('typingIndicator').classList.toggle('active', show);
            if (show) scrollToBottom();
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                const container = document.getElementById('chatContainer');
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        function sendMessage() {
            const input = document.getElementById('textInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            input.style.height = 'auto';
            processMessage(message);
        }
        
        function updateTextInput(text) {
            const input = document.getElementById('textInput');
            input.value = text;
            autoResize(input);
        }
        
        // Process collected data and actively ask next question
        function processCollectedData(message, data, responseData) {
            const lowerMessage = message.toLowerCase();
            let nextQuestion = '';
            
            // Update collected data from response
            if (responseData.farmerName && !collectedData.farmerName) {
                collectedData.farmerName = responseData.farmerName;
            }
            if (responseData.location && !collectedData.location) {
                collectedData.location = responseData.location;
            }
            if (responseData.cropName && !collectedData.cropName) {
                collectedData.cropName = responseData.cropName;
            }
            if (responseData.quantity && !collectedData.quantity) {
                collectedData.quantity = responseData.quantity;
            }
            if (responseData.price && !collectedData.price) {
                collectedData.price = responseData.price;
            }
            
            // Extract farmer name if asking for name
            if (conversationState === 'asking_name') {
                if (responseData.farmerName) {
                    collectedData.farmerName = responseData.farmerName;
                } else if (message.length < 50 && !lowerMessage.includes('have') && !lowerMessage.includes('want') && !lowerMessage.includes('sell') && !lowerMessage.includes('kg') && !lowerMessage.includes('kilo')) {
                    // Simple extraction - take first part as name
                    collectedData.farmerName = message.trim().split(/[,\s]+/)[0];
                }
                
                if (collectedData.farmerName && collectedData.farmerName.length > 1) {
                    nextQuestion = `Thank you ${collectedData.farmerName}! Now, what crop do you want to sell?`;
                    conversationState = 'asking_crop';
                } else {
                    nextQuestion = `I didn't catch your name. Could you please tell me your name?`;
                    conversationState = 'asking_name'; // Stay in same state
                }
            }
            
            // Extract crop name (question 2: Crop name)
            else if (conversationState === 'asking_crop') {
                if (responseData.cropName) {
                    collectedData.cropName = responseData.cropName;
                } else if (data.cropName) {
                    collectedData.cropName = data.cropName;
                } else {
                    // Simple extraction - common crop names
                    const cropKeywords = ['wheat', 'rice', 'tomato', 'cotton', 'sugarcane', 'corn', 'potato', 'onion', 'chili', 'mango', 'banana'];
                    for (let crop of cropKeywords) {
                        if (lowerMessage.includes(crop)) {
                            collectedData.cropName = crop;
                            break;
                        }
                    }
                    if (!collectedData.cropName && message.length < 40) {
                        collectedData.cropName = message.trim().toLowerCase();
                    }
                }
                
                if (collectedData.cropName) {
                    nextQuestion = `Perfect! ${collectedData.cropName} is a great crop. How many kilograms do you have?`;
                    conversationState = 'asking_quantity';
                } else {
                    nextQuestion = `I didn't catch the crop name. What crop would you like to sell?`;
                    conversationState = 'asking_crop'; // Stay in same state
                }
            }
            
            // Extract quantity (question 3: How many kgs)
            else if (conversationState === 'asking_quantity') {
                if (responseData.quantity) {
                    collectedData.quantity = parseFloat(responseData.quantity);
                } else if (data.quantity) {
                    collectedData.quantity = parseFloat(data.quantity);
                } else {
                    // Extract numbers from message
                    const numMatch = message.match(/(\d+(?:\.\d+)?)/);
                    if (numMatch) {
                        collectedData.quantity = parseFloat(numMatch[1]);
                    }
                }
                
                if (collectedData.quantity && collectedData.quantity > 0) {
                    nextQuestion = `Excellent! ${collectedData.quantity} kilograms. Now, which city are you located in?`;
                    conversationState = 'asking_location';
                } else {
                    nextQuestion = `I didn't catch the quantity. How many kilograms do you have?`;
                    conversationState = 'asking_quantity'; // Stay in same state
                }
            }
            
            // Extract location (question 4: City)
            else if (conversationState === 'asking_location') {
                if (responseData.location) {
                    collectedData.location = responseData.location;
                } else {
                    const locationPattern = /(?:from|in|at|located|place|village|city|region|am|i'm|live|stay)\s+([A-Za-z\s,]+)/i;
                    const match = message.match(locationPattern);
                    if (match && match[1]) {
                        collectedData.location = match[1].trim();
                    } else if (message.length < 60 && !message.includes('kg') && !message.includes('rupee') && !message.match(/\d+/)) {
                        collectedData.location = message.trim();
                    }
                }
                
                if (collectedData.location && collectedData.location.length > 2) {
                    nextQuestion = `Great! ${collectedData.location} is a good farming region. Finally, what price per kilogram are you expecting in rupees?`;
                    conversationState = 'asking_price';
                } else {
                    nextQuestion = `I didn't catch your location. Which city are you located in?`;
                    conversationState = 'asking_location'; // Stay in same state
                }
            }
            
            // Extract price (question 5: Price per crop)
            else if (conversationState === 'asking_price') {
                if (responseData.price) {
                    collectedData.price = parseFloat(responseData.price);
                } else if (data.price) {
                    collectedData.price = parseFloat(data.price);
                } else {
                    // Extract numbers from message
                    const numMatch = message.match(/(\d+(?:\.\d+)?)/);
                    if (numMatch) {
                        collectedData.price = parseFloat(numMatch[1]);
                    }
                }
                
                if (collectedData.price && collectedData.price > 0) {
                    // All data collected - show summary and create post
                    showCollectedDataSummary();
                    nextQuestion = `Perfect! ‚Çπ${collectedData.price} per kg. Let me create your crop listing now.`;
                    conversationState = 'confirming';
                    
                    // Auto-create post after showing summary
                    setTimeout(() => {
                        createPostFromCollectedData();
                    }, 2000);
                } else {
                    nextQuestion = `I didn't catch the price. What price per kilogram are you expecting in rupees?`;
                    conversationState = 'asking_price'; // Stay in same state
                }
            }
            
            // Update responseData with collected info
            if (collectedData.farmerName) responseData.farmerName = collectedData.farmerName;
            if (collectedData.location) responseData.location = collectedData.location;
            if (collectedData.cropName) responseData.cropName = collectedData.cropName;
            if (collectedData.quantity) responseData.quantity = collectedData.quantity;
            if (collectedData.price) responseData.price = collectedData.price;
            
            return nextQuestion;
        }
        
        function showCollectedDataSummary() {
            // Create a detailed summary card
            const summaryCard = document.createElement('div');
            summaryCard.className = 'crop-details-card';
            summaryCard.style.marginTop = '20px';
            summaryCard.innerHTML = `
                <h4>üìã Your Crop Listing Summary</h4>
                <div style="margin-top: 15px;">
                    <div class="detail-row" style="margin-bottom: 10px;">
                        <span class="detail-label">üë§ Name:</span>
                        <span class="detail-value">${collectedData.farmerName || 'Not provided'}</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 10px;">
                        <span class="detail-label">üåæ Crop:</span>
                        <span class="detail-value">${collectedData.cropName || 'Not provided'}</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 10px;">
                        <span class="detail-label">üì¶ Quantity:</span>
                        <span class="detail-value">${collectedData.quantity || 'Not provided'} kg</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 10px;">
                        <span class="detail-label">üìç City:</span>
                        <span class="detail-value">${collectedData.location || 'Not provided'}</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 10px;">
                        <span class="detail-label">üí∞ Price per kg:</span>
                        <span class="detail-value">‚Çπ${collectedData.price || 'Not provided'}</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #667eea;">
                    <strong style="color: #667eea;">Creating your listing now...</strong>
                </div>
            `;
            
            // Add to conversation
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group assistant';
            const avatar = document.createElement('div');
            avatar.className = 'avatar assistant';
            avatar.textContent = 'üåæ';
            const content = document.createElement('div');
            content.className = 'message-content';
            content.appendChild(summaryCard);
            messageGroup.appendChild(avatar);
            messageGroup.appendChild(content);
            
            const chatContainer = document.getElementById('chatContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen && welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
            }
            chatContainer.appendChild(messageGroup);
            scrollConversationToBottom();
        }
        
        async function createPostFromCollectedData() {
            if (!collectedData.cropName || !collectedData.quantity || !collectedData.price) {
                return;
            }
            
            try {
                const language = document.getElementById('languageSelect').value;
                const phone = '+919876543210';
                
                // Create a message with all collected data in the correct order
                const fullMessage = `My name is ${collectedData.farmerName || 'Farmer'}. I want to sell ${collectedData.cropName}. I have ${collectedData.quantity} kg. I am from ${collectedData.location}. The price is ${collectedData.price} rupees per kg.`;
                
                const response = await fetch('/api/voice/conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        speechText: fullMessage,
                        phone: phone,
                        language: language,
                        conversationHistory: conversationHistory
                    })
                });
                
                const data = await response.json();
                const responseData = data.data || {};
                
                if (data.postCreated) {
                    const successMsg = `‚úÖ Great! Your crop listing has been created successfully! Your crop is now visible to buyers.`;
                    addAIMessage(successMsg, responseData);
                    speakText(successMsg, true);
                }
                
                // Reset collected data for new conversation
                collectedData = {
                    farmerName: null,
                    location: null,
                    cropName: null,
                    quantity: null,
                    price: null
                };
                conversationState = 'greeting';
                
            } catch (error) {
                console.error('Error creating post:', error);
            }
        }
        
        // Enable send button when there's text
        document.getElementById('textInput').addEventListener('input', function() {
            document.getElementById('sendButton').disabled = !this.value.trim();
        });
    </script>
</body>
</html>
